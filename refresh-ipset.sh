#!/system/bin/sh
#
# ============================================================================== 
# ğŸ”„ refresh-ipset.sh - IPSet è§„åˆ™åˆ·æ–°å®ˆæŠ¤è„šæœ¬
# ============================================================================== 
#
# å®šæœŸè°ƒç”¨è§„åˆ™è„šæœ¬åˆ·æ–° IPSetï¼Œç¡®ä¿ä»£ç†è§„åˆ™å®æ—¶æ›´æ–°ã€‚
# - åå°è¿è¡Œï¼Œå®šæ—¶æ‰§è¡Œåˆ·æ–°å‘½ä»¤
# - ä¿è¯å‡ºç«™æœåŠ¡å™¨ IP åˆ—è¡¨åŠæ—¶åŒæ­¥
#
# ==============================================================================
set -e

# --- åˆå§‹åŒ–ä¸å˜é‡å®šä¹‰ ---
MODDIR=$(dirname "$0")
# shellcheck source=common.sh
. "$MODDIR/common.sh"

# --- å¯é…ç½®å˜é‡ ---

# åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰, å¯ä»¥ä»å¤–éƒ¨é€šè¿‡ç¯å¢ƒå˜é‡ REFRESH_INTERVAL_SEC è®¾ç½®, é»˜è®¤ä¸º 900 ç§’ï¼ˆ15 åˆ†é’Ÿï¼‰ã€‚
INTERVAL=${REFRESH_INTERVAL_SEC:-900}

log "ğŸ”„ [refresh-ipset.sh]: å¯åŠ¨ ipset åˆ·æ–°ï¼Œé—´éš” ${INTERVAL} ç§’"

if [ ! -x "$START_RULES" ]; then
  log "âŒ [refresh-ipset.sh]: è§„åˆ™è„šæœ¬ $(basename "$START_RULES") ä¸å¯æ‰§è¡Œï¼Œå¯åŠ¨å¤±è´¥"
  exit 0
fi

# --- ä¸»å¾ªç¯ ---
refresh_ipset_loop() {
  while true; do
    log "ğŸ”„ [refresh-ipset.sh]: æ‰§è¡Œåˆ·æ–°..."
    # æ‰§è¡Œåˆ·æ–°å‘½ä»¤, å¹¶å°†è¾“å‡ºè¿½åŠ åˆ°ä¸»æ—¥å¿—æ–‡ä»¶
    sh "$START_RULES" refresh >> "$LOGFILE" 2>&1 || log "âŒ [refresh-ipset.sh]: è„šæœ¬ $(basename "$START_RULES") è°ƒç”¨å¤±è´¥"
    # ç­‰å¾…æŒ‡å®šçš„é—´éš”æ—¶é—´
    sleep "$INTERVAL"
  done
}

refresh_ipset_loop